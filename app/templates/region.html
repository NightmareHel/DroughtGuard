<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const region = urlParams.get('region');
    
    if (!region) {
        window.location.href = '/';
        return;
    }

    // Update region title
    document.getElementById('region-title').textContent = region;

    // Fetch predictions from backend
    fetch('/api/predict', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ region: region })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) throw new Error(data.error);
        if (!data.predictions) throw new Error("No prediction data returned.");

        console.log("🔮 Predictions received:", data.predictions);

        // Update last updated timestamp
        document.getElementById('last-updated').textContent = new Date().toLocaleString();

        // Map horizon keys safely
        const horizonMap = {
            "1_month": 1,
            "2_month": 2,
            "3_month": 3
        };

        // Update all horizon cards
        for (const [key, pred] of Object.entries(data.predictions)) {
            const h = horizonMap[key];
            if (!h) {
                console.warn(`⚠️ Unknown horizon key: ${key}`);
                continue;
            }

            const probPercent = (pred.probability * 100).toFixed(1);
            const category = pred.category || "Unknown";
            const color = pred.color || "#999";

            // Update label
            document.getElementById(`risk-label-${h}`).textContent = category;

            // Update probability text
            document.getElementById(`risk-prob-${h}`).textContent = `${probPercent}% Risk`;

            // Update progress bar
            const riskBar = document.getElementById(`risk-bar-${h}`);
            riskBar.style.width = `${probPercent}%`;
            riskBar.style.backgroundColor = color;

            // Update circular indicator
            const indicator = document.getElementById(`risk-${h}`);
            indicator.style.backgroundColor = color;
        }

        // Render placeholder chart for historical trends
        renderHistoricalChart(region);
    })
    .catch(error => {
        console.error('❌ Error loading predictions:', error);
        alert('Failed to load predictions: ' + error.message);
    });

    // ====================================================
    // CHART.JS DUMMY HISTORICAL DATA VISUALIZATION
    // ====================================================
    function renderHistoricalChart(region) {
        const ctx = document.getElementById('historical-chart');
        if (!ctx) {
            console.warn("⚠️ No chart element found in DOM.");
            return;
        }

        // Dummy sample data — replace later with backend history
        const months = ["Jun", "Jul", "Aug", "Sep", "Oct", "Nov"];
        const riskData = [0.3, 0.35, 0.42, 0.5, 0.47, 0.55];

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: `Predicted Risk for ${region}`,
                    data: riskData.map(x => x * 100),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: "Risk (%)" }
                    },
                    x: {
                        title: { display: true, text: "Month" }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
});
</script>
